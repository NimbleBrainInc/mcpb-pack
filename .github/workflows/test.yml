name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux-x64
          - runner: ubuntu-24.04-arm
            platform: linux-arm64
          - runner: macos-14
            platform: darwin-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Create test project
        run: |
          cat > manifest.json << 'EOF'
          {
            "manifest_version": "0.3",
            "name": "test/example",
            "version": "1.0.0",
            "description": "Test extension",
            "author": { "name": "Test" },
            "server": {
              "type": "python",
              "entry_point": "server.py",
              "mcp_config": {
                "command": "python",
                "args": ["${__dirname}/server.py"]
              }
            }
          }
          EOF

          mkdir -p src/test_server
          cat > pyproject.toml << 'EOF'
          [project]
          name = "test-server"
          version = "1.0.0"
          requires-python = ">=3.11"
          dependencies = ["httpx>=0.27.0"]

          [build-system]
          requires = ["hatchling"]
          build-backend = "hatchling.build"

          [tool.hatch.build.targets.wheel]
          packages = ["src/test_server"]
          EOF

          cat > src/test_server/__init__.py << 'EOF'
          import httpx
          __version__ = "1.0.0"
          EOF

          cat > server.py << 'EOF'
          from test_server import httpx
          print(f"httpx version: {httpx.__version__}")
          EOF

          cat > .mcpbignore << 'EOF'
          .venv/
          __pycache__/
          EOF

      - name: Test action
        id: pack
        uses: ./
        with:
          output: test-${{ matrix.platform }}.mcpb
          announce: false  # Don't announce test builds

      - name: Verify bundle
        run: |
          BUNDLE="${{ steps.pack.outputs.bundle-path }}"
          SIZE="${{ steps.pack.outputs.bundle-size }}"

          echo "Bundle: $BUNDLE"
          echo "Size: $SIZE bytes ($(du -h $BUNDLE | cut -f1))"

          # Check bundle exists
          if [ ! -f "$BUNDLE" ]; then
            echo "ERROR: Bundle not found"
            exit 1
          fi

          # Check deps were vendored
          if ! unzip -l "$BUNDLE" | grep -q "deps/"; then
            echo "ERROR: deps/ folder not found in bundle"
            unzip -l "$BUNDLE"
            exit 1
          fi

          # Check httpx was installed
          if ! unzip -l "$BUNDLE" | grep -q "httpx"; then
            echo "ERROR: httpx not found in deps"
            exit 1
          fi

          echo "Bundle contents:"
          unzip -l "$BUNDLE" | head -30

  test-existing-bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test project with pre-built bundle
        run: |
          mkdir -p test-project
          cd test-project

          cat > manifest.json << 'EOF'
          {
            "manifest_version": "0.3",
            "name": "test/existing",
            "version": "2.0.0",
            "description": "Test existing bundle",
            "author": { "name": "Test" },
            "server": {
              "type": "python",
              "entry_point": "server.py",
              "mcp_config": {
                "command": "python",
                "args": ["${__dirname}/server.py"]
              }
            }
          }
          EOF

          # Create a fake pre-built bundle (just a zip with manifest)
          echo "print('hello')" > server.py
          zip existing.mcpb manifest.json server.py

      - name: Test action with existing bundle
        id: existing
        uses: ./
        with:
          directory: test-project
          bundle-path: existing.mcpb
          build: false
          upload: false
          announce: false

      - name: Verify outputs
        run: |
          BUNDLE="${{ steps.existing.outputs.bundle-path }}"
          SIZE="${{ steps.existing.outputs.bundle-size }}"
          SHA256="${{ steps.existing.outputs.bundle-sha256 }}"

          echo "Bundle: $BUNDLE"
          echo "Size: $SIZE bytes"
          echo "SHA256: $SHA256"

          # Check outputs are populated
          if [ -z "$BUNDLE" ]; then
            echo "ERROR: bundle-path output is empty"
            exit 1
          fi

          if [ -z "$SIZE" ] || [ "$SIZE" = "0" ]; then
            echo "ERROR: bundle-size output is empty or zero"
            exit 1
          fi

          if [ -z "$SHA256" ]; then
            echo "ERROR: bundle-sha256 output is empty"
            exit 1
          fi

          # Verify SHA256 matches actual file
          ACTUAL_SHA256=$(sha256sum test-project/$BUNDLE | cut -d' ' -f1)
          if [ "$SHA256" != "$ACTUAL_SHA256" ]; then
            echo "ERROR: SHA256 mismatch"
            echo "Expected: $ACTUAL_SHA256"
            echo "Got: $SHA256"
            exit 1
          fi

          echo "All outputs verified successfully"
