name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Create test project
        run: |
          cat > manifest.json << 'EOF'
          {
            "manifest_version": "0.3",
            "name": "test/example",
            "version": "1.0.0",
            "description": "Test extension",
            "author": { "name": "Test" },
            "server": {
              "type": "python",
              "entry_point": "server.py",
              "mcp_config": {
                "command": "python",
                "args": ["${__dirname}/server.py"]
              }
            }
          }
          EOF

          mkdir -p src/test_server
          cat > pyproject.toml << 'EOF'
          [project]
          name = "test-server"
          version = "1.0.0"
          requires-python = ">=3.11"
          dependencies = ["httpx>=0.27.0"]

          [build-system]
          requires = ["hatchling"]
          build-backend = "hatchling.build"

          [tool.hatch.build.targets.wheel]
          packages = ["src/test_server"]
          EOF

          cat > src/test_server/__init__.py << 'EOF'
          import httpx
          __version__ = "1.0.0"
          EOF

          cat > server.py << 'EOF'
          from test_server import httpx
          print(f"httpx version: {httpx.__version__}")
          EOF

          cat > .mcpbignore << 'EOF'
          .venv/
          __pycache__/
          EOF

      - name: Test action
        id: pack
        uses: ./
        with:
          output: test-${{ matrix.arch }}.mcpb
          announce: false  # Don't announce test builds

      - name: Verify bundle
        run: |
          BUNDLE="${{ steps.pack.outputs.bundle-path }}"
          SIZE="${{ steps.pack.outputs.bundle-size }}"

          echo "Bundle: $BUNDLE"
          echo "Size: $SIZE bytes ($(du -h $BUNDLE | cut -f1))"

          # Check bundle exists
          if [ ! -f "$BUNDLE" ]; then
            echo "ERROR: Bundle not found"
            exit 1
          fi

          # Check deps were vendored
          if ! unzip -l "$BUNDLE" | grep -q "deps/"; then
            echo "ERROR: deps/ folder not found in bundle"
            unzip -l "$BUNDLE"
            exit 1
          fi

          # Check httpx was installed
          if ! unzip -l "$BUNDLE" | grep -q "httpx"; then
            echo "ERROR: httpx not found in deps"
            exit 1
          fi

          echo "Bundle contents:"
          unzip -l "$BUNDLE" | head -30
